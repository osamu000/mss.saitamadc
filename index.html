
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業日報アプリ</title>
    <!-- External Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom": "https://esm.sh/react-dom@^19.2.4",
    "react-dom/client": "https://esm.sh/react-dom@^19.2.4/client",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom scrollbar for better mobile feel */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Time input styling */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Plus, Share2, Check, Send, Save, Trash2, CheckCircle2, 
            Clock, Calendar as CalendarIcon, User, FileText, 
            ChevronDown, Lock, Github, Camera, Image as ImageIcon, X, Circle, RefreshCw
        } from 'lucide-react';

        // --- Types & Constants ---
        const Category = {
            DEVELOPMENT: '開発',
            DESIGN: 'デザイン',
            MEETING: '会議',
            SUPPORT: 'サポート',
            OTHER: 'その他'
        };

        const WORKERS = ['佐藤 一郎', '鈴木 幸子', '高橋 健二', '田中 美咲', '伊藤 直樹'];
        const CATEGORIES = Object.values(Category);
        const STORAGE_KEY = 'work_report_drafts';
        
        // 【重要】GASのURLをここに貼り付けてください
        const GOOGLE_SHEETS_WEB_APP_URL = 'AKfycbz-dhGczAcTBUY8bE12AduLEsxgbK_z3_vN3r8REagbdXnZkuOkgyPO883p-Q6HPGRwYQ';

        // --- Services ---
        const calculateDuration = (start, end) => {
            if (!start || !end) return '0.0';
            const startTime = new Date(`1970-01-01T${start}`);
            const endTime = new Date(`1970-01-01T${end}`);
            let diff = (endTime.getTime() - startTime.getTime()) / (1000 * 60 * 60);
            if (diff < 0) diff += 24; 
            return diff.toFixed(1);
        };

        const sendToGoogleSheets = async (report) => {
            if (!GOOGLE_SHEETS_WEB_APP_URL || GOOGLE_SHEETS_WEB_APP_URL === 'ここにGASのデプロイURLを貼り付けてください') {
                console.warn('Google Sheets URL not configured. Simulating success.');
                return new Promise((resolve) => setTimeout(() => resolve(true), 1500));
            }
            try {
                await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(report),
                });
                return true;
            } catch (error) {
                console.error('Failed to send report:', error);
                return false;
            }
        };

        // --- Components ---
        const TimeSummaryBar = ({ totalHours, onAddRow }) => {
            const [copied, setCopied] = useState(false);
            const progress = Math.min((totalHours / 8) * 100, 100);

            const handleShare = () => {
                navigator.clipboard.writeText(window.location.href);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            
            return (
                <div className="fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-md shadow-sm p-4 border-b border-slate-200">
                    <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                        <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                            <div className="flex items-center gap-3">
                                <span className="text-3xl font-black text-indigo-600 font-mono">
                                    {totalHours.toFixed(1)} <small className="text-lg font-medium text-slate-400">h</small>
                                </span>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={handleShare} className={`p-2.5 rounded-xl border transition-all flex items-center gap-2 text-sm font-bold ${copied ? 'bg-green-50 border-green-200 text-green-600' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                    {copied ? <Check className="w-4 h-4" /> : <Share2 className="w-4 h-4" />}
                                    <span className="hidden sm:inline">{copied ? 'コピー完了' : '共有'}</span>
                                </button>
                                <button onClick={onAddRow} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-indigo-100">
                                    <Plus className="w-4 h-4" />
                                    <span className="whitespace-nowrap">行を追加</span>
                                </button>
                            </div>
                        </div>
                        <div className="w-full md:flex-1 md:max-w-md bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div className="bg-indigo-500 h-full transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ImageUploader = ({ onImageChange, currentImage }) => {
            const fileInputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [stream, setStream] = useState(null);
            const [error, setError] = useState(null);

            const startCamera = async () => {
                setError(null);
                try {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' },
                        audio: false
                    });
                    setStream(mediaStream);
                    if (videoRef.current) videoRef.current.srcObject = mediaStream;
                    setIsCameraActive(true);
                } catch (err) {
                    setError("カメラの起動に失敗しました。権限設定を確認してください。");
                }
            };

            const stopCamera = useCallback(() => {
                if (stream) stream.getTracks().forEach(track => track.stop());
                setStream(null);
                setIsCameraActive(false);
            }, [stream]);

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const context = canvas.getContext('2d');
                    canvas.width = videoRef.current.videoWidth;
                    canvas.height = videoRef.current.videoHeight;
                    context.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                    onImageChange(canvas.toDataURL('image/jpeg'));
                    stopCamera();
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => onImageChange(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="space-y-4">
                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">現場画像 / 添付</label>
                    {error && <div className="text-xs text-red-500 bg-red-50 p-2 rounded-lg border border-red-100">{error}</div>}
                    {!currentImage && !isCameraActive && (
                        <div className="grid grid-cols-2 gap-4">
                            <button type="button" onClick={startCamera} className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-slate-200 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all text-slate-400 group bg-white">
                                <Camera className="w-8 h-8 mb-2 group-hover:text-indigo-500" />
                                <span className="text-xs font-bold">カメラ起動</span>
                            </button>
                            <button type="button" onClick={() => fileInputRef.current?.click()} className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-slate-200 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all text-slate-400 group bg-white">
                                <ImageIcon className="w-8 h-8 mb-2 group-hover:text-indigo-500" />
                                <span className="text-xs font-bold">画像を選択</span>
                                <input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleFileChange} />
                            </button>
                        </div>
                    )}
                    {isCameraActive && (
                        <div className="relative rounded-2xl overflow-hidden bg-black aspect-video shadow-xl border-4 border-indigo-500">
                            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                            <div className="absolute inset-0 flex flex-col justify-between p-4">
                                <div className="flex justify-end"><button onClick={stopCamera} className="p-2 bg-black/50 text-white rounded-full"><X className="w-6 h-6" /></button></div>
                                <div className="flex justify-center pb-4"><button onClick={capturePhoto} className="group relative flex items-center justify-center"><Circle className="w-16 h-16 text-white opacity-50" /><div className="absolute w-12 h-12 bg-white rounded-full group-active:scale-90 transition-transform shadow-lg" /></button></div>
                            </div>
                            <canvas ref={canvasRef} className="hidden" />
                        </div>
                    )}
                    {currentImage && (
                        <div className="relative rounded-2xl overflow-hidden shadow-sm border border-slate-200 aspect-video group">
                            <img src={currentImage} className="w-full h-full object-cover" />
                            <button onClick={() => onImageChange(null)} className="absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full shadow-lg"><X className="w-5 h-5" /></button>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [reports, setReports] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showSuccess, setShowSuccess] = useState(false);
            const [workDate, setWorkDate] = useState(new Date().toISOString().split('T')[0]);
            const [workerName, setWorkerName] = useState(WORKERS[0]);
            const [remarks, setRemarks] = useState('');
            const [attachedImage, setAttachedImage] = useState(null);
            
            const createEmptyItem = () => ({
                id: crypto.randomUUID(),
                category: Category.DEVELOPMENT,
                startTime: '09:00',
                endTime: '10:00',
                workDuration: '1.0',
                content: ''
            });

            const [items, setItems] = useState([createEmptyItem()]);

            useEffect(() => {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) setReports(JSON.parse(data));
            }, []);

            const totalHours = useMemo(() => {
                const current = items.reduce((acc, item) => acc + parseFloat(item.workDuration || '0'), 0);
                const saved = reports.reduce((acc, report) => acc + report.items.reduce((sum, item) => sum + parseFloat(item.workDuration || '0'), 0), 0);
                return current + saved;
            }, [items, reports]);

            const updateItem = (id, updates) => {
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        const newItem = { ...item, ...updates };
                        if (updates.startTime || updates.endTime) newItem.workDuration = calculateDuration(newItem.startTime, newItem.endTime);
                        return newItem;
                    }
                    return item;
                }));
            };

            const addItem = useCallback(() => {
                const last = items[items.length - 1];
                const newItem = createEmptyItem();
                if (last) {
                    newItem.startTime = last.endTime;
                    const [h, m] = last.endTime.split(':').map(Number);
                    newItem.endTime = `${((h + 1) % 24).toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    newItem.workDuration = calculateDuration(newItem.startTime, newItem.endTime);
                }
                setItems(prev => [...prev, newItem]);
            }, [items]);

            const handleSaveDraft = () => {
                if (items.some(i => !i.content)) return alert('作業内容を入力してください');
                const newReport = {
                    id: crypto.randomUUID(),
                    workDate, workerName, items, remarks, attachedImage,
                    isApproved: false,
                    createdAt: new Date().toISOString()
                };
                const updated = [...reports, newReport];
                setReports(updated);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                setItems([createEmptyItem()]);
                setRemarks('');
                setAttachedImage(null);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleFinalSend = async () => {
                if (reports.length === 0) return alert('保存済みの記録がありません。');
                setIsSubmitting(true);
                try {
                    for (const report of reports) {
                        for (const item of report.items) {
                            await sendToGoogleSheets({ ...item, workDate: report.workDate, workerName: report.workerName, remarks: report.remarks });
                        }
                    }
                    setReports([]);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
                    setShowSuccess(true);
                    setTimeout(() => setShowSuccess(false), 3000);
                } catch (error) {
                    alert('送信エラーが発生しました。');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 pb-32">
                    <TimeSummaryBar totalHours={totalHours} onAddRow={addItem} />
                    <div className="max-w-6xl mx-auto px-4 pt-28 space-y-6 fade-in">
                        {/* Header Info */}
                        <div className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-xs font-black text-slate-400 uppercase flex items-center gap-2"><CalendarIcon className="w-3.5 h-3.5" /> 作業日</label>
                                    <input type="date" value={workDate} onChange={(e) => setWorkDate(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-black text-slate-400 uppercase flex items-center gap-2"><User className="w-3.5 h-3.5" /> 作業者</label>
                                    <div className="relative">
                                        <select value={workerName} onChange={(e) => setWorkerName(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 appearance-none">
                                            {WORKERS.map(w => <option key={w} value={w}>{w}</option>)}
                                        </select>
                                        <ChevronDown className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Table Section */}
                        <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-slate-800 px-6 py-4 text-white flex justify-between items-center">
                                <h2 className="text-sm font-bold flex items-center gap-2"><FileText className="w-4 h-4 text-indigo-400" /> 日報入力エリア</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse min-w-[800px]">
                                    <thead className="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-200">
                                        <tr>
                                            <th className="px-6 py-4 w-[120px]">開始</th>
                                            <th className="px-6 py-4 w-[120px]">終了</th>
                                            <th className="px-6 py-4 w-[80px] text-center">時間</th>
                                            <th className="px-6 py-4">作業内容</th>
                                            <th className="px-6 py-4 w-[160px]">カテゴリー</th>
                                            <th className="px-6 py-4 w-[60px]"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {items.map((item) => (
                                            <tr key={item.id} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="px-6 py-4">
                                                    <input type="time" value={item.startTime} onChange={(e) => updateItem(item.id, { startTime: e.target.value })} className="w-full p-2.5 border border-slate-200 rounded-xl text-xs font-bold" />
                                                </td>
                                                <td className="px-6 py-4">
                                                    <input type="time" value={item.endTime} onChange={(e) => updateItem(item.id, { endTime: e.target.value })} className="w-full p-2.5 border border-slate-200 rounded-xl text-xs font-bold" />
                                                </td>
                                                <td className="px-6 py-4 text-center">
                                                    <span className="text-xs font-black text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg border border-indigo-100">{item.workDuration}h</span>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <textarea rows={1} placeholder="作業詳細を入力..." value={item.content} onChange={(e) => updateItem(item.id, { content: e.target.value })} className="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50/30 resize-none min-h-[42px]" />
                                                </td>
                                                <td className="px-6 py-4">
                                                    <select value={item.category} onChange={(e) => updateItem(item.id, { category: e.target.value })} className="w-full p-2.5 border border-slate-200 rounded-xl text-xs font-bold bg-white">
                                                        {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                                    </select>
                                                </td>
                                                <td className="px-6 py-4 text-center">
                                                    <button onClick={() => setItems(items.filter(i => i.id !== item.id))} disabled={items.length <= 1} className="text-slate-200 hover:text-red-500 disabled:opacity-0 transition-colors"><Trash2 className="w-5 h-5" /></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="p-8 bg-slate-50/50 border-t border-slate-200 space-y-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        <ImageUploader onImageChange={setAttachedImage} currentImage={attachedImage} />
                                    </div>
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">備考 / 特記事項</label>
                                            <textarea placeholder="自由記述欄" rows={4} value={remarks} onChange={(e) => setRemarks(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-white" />
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleSaveDraft} className="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-3xl font-black text-lg flex items-center justify-center gap-3 shadow-xl shadow-indigo-100 transition-all active:scale-[0.98]"><Save className="w-6 h-6" /> この内容を一時保存</button>
                            </div>
                        </div>

                        {/* Saved Reports */}
                        {reports.length > 0 && (
                            <div className="space-y-4 pt-4 pb-12">
                                <h2 className="text-lg font-black text-slate-800 flex items-center gap-2 px-2"><Clock className="w-5 h-5 text-indigo-600" /> 送信待ち ({reports.length}件)</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {reports.map((report) => (
                                        <div key={report.id} className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm relative group hover:border-indigo-300 transition-all">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <span className="text-sm font-black text-slate-800 block">{report.workDate}</span>
                                                    <span className="text-[10px] text-slate-400 font-bold uppercase">{report.workerName}</span>
                                                </div>
                                                <div className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-black">{report.items.reduce((sum, i) => sum + parseFloat(i.workDuration), 0).toFixed(1)}h</div>
                                            </div>
                                            <div className="space-y-1">
                                                {report.items.slice(0, 2).map((item, idx) => <p key={idx} className="text-[10px] text-slate-500 truncate">• {item.content}</p>)}
                                            </div>
                                            <button onClick={() => setReports(reports.filter(r => r.id !== report.id))} className="absolute top-4 right-4 p-1.5 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Trash2 className="w-4 h-4" /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer / Send Button */}
                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-white/90 backdrop-blur-xl border-t border-slate-200 z-40">
                        <div className="max-w-xl mx-auto">
                            <button onClick={handleFinalSend} disabled={isSubmitting || reports.length === 0} className={`w-full py-5 rounded-full font-black text-xl flex items-center justify-center gap-3 transition-all shadow-2xl ${reports.length > 0 ? 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-indigo-200 active:scale-[0.99]' : 'bg-slate-200 text-slate-400 cursor-not-allowed shadow-none'}`}>
                                {isSubmitting ? <div className="w-7 h-7 border-4 border-white/30 border-t-white rounded-full animate-spin" /> : <><Send className="w-6 h-6" /> スプレッドシートへ送信</>}
                            </button>
                        </div>
                    </div>

                    {showSuccess && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[60] animate-in fade-in zoom-in duration-300">
                            <div className="bg-green-600 text-white px-10 py-5 rounded-full shadow-2xl flex items-center gap-4 font-black">
                                <CheckCircle2 className="w-7 h-7" /> 送信完了しました！
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
